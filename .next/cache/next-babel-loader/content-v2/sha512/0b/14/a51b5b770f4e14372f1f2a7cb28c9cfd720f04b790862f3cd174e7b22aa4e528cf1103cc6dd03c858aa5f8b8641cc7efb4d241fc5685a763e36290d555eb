{"ast":null,"code":"import moment from 'moment-timezone';\nimport { getPageviewStats } from 'lib/queries';\nimport { ok, badRequest, methodNotAllowed, unauthorized } from 'lib/response';\nimport { allowQuery } from 'lib/auth';\nconst unitTypes = ['year', 'month', 'hour', 'day'];\nexport default (async (req, res) => {\n  if (req.method === 'GET') {\n    if (!(await allowQuery(req))) {\n      return unauthorized(res);\n    }\n\n    const {\n      id,\n      start_at,\n      end_at,\n      unit,\n      tz,\n      url\n    } = req.query;\n    const websiteId = +id;\n    const startDate = new Date(+start_at);\n    const endDate = new Date(+end_at);\n\n    if (!moment.tz.zone(tz) || !unitTypes.includes(unit)) {\n      return badRequest(res);\n    }\n\n    const [pageviews, sessions] = await Promise.all([getPageviewStats(websiteId, startDate, endDate, tz, unit, '*', url), getPageviewStats(websiteId, startDate, endDate, tz, unit, 'distinct session_id', url)]);\n    return ok(res, {\n      pageviews,\n      sessions\n    });\n  }\n\n  return methodNotAllowed(res);\n});","map":null,"metadata":{},"sourceType":"module"}